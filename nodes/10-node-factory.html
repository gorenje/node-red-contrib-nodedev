<script type="text/html" data-template-name="NodeFactory">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <div style="display: inline-block; width: calc(100% - 105px)"><input type="text" id="node-input-name" placeholder="Name"></div>
    </div>

    <div class="form-row">
        <label for="node-input-autoimport">
                <span>Auto Import of Nodes?</span>
            </label>
        <input type="checkbox" id="node-input-autoimport" style="display:inline-block; width:15px; vertical-align:baseline;">
    </div>

    <div class="form-row">
        <label for="node-input-nodename"><i class="fa fa-tag"></i> Node Name</label>
        <div style="display: inline-block; width: calc(100% - 105px)"><input type="text" id="node-input-nodename" placeholder="Node Name">
        </div>
    </div> 

    <div class="form-row">
        <label for="node-input-category"><i class="fa fa-tag"></i> Node Name</label>
        <div style="display: inline-block; width: calc(100% - 105px)"><input type="text" id="node-input-category" placeholder="Node Category">
        </div>
    </div>

    <div id="node-input-row-style-colour" class="form-row">
        <label>Color</label>
     </div>

    <div id="node-input-row-icon-picker" class="form-row">
    </div>

    <div class="form-row">
        <label for="node-input-hasbutton">
            <span>Has button?</span>
        </label>
        <input type="checkbox" id="node-input-hasbutton" style="display:inline-block; width:15px; vertical-align:baseline;">
    </div>

    <div class="form-row">
        <label for="node-input-hasinput">
            <span>Has input port?</span>
        </label>
        <input type="checkbox" id="node-input-hasinput" style="display:inline-block; width:15px; vertical-align:baseline;">
    </div>

    <div class="form-row">
        <label for="node-input-outputcount">
            <i class="fa fa-tag"></i> Output ports
          </label>
        <select id="node-input-outputcount"></select>
    </div>

    <div class="form-row">
        <label for="node-input-summary">
          <i class="fa fa-tag"></i>
          <span>Summary</span>
        </label>
        <div style="height: 150px; min-height:150px; max-height: 150px;" class="node-text-editor" id="node-input-summary">
        </div>
    </div>

    <div class="form-row">
        <label for="node-input-description">
              <i class="fa fa-tag"></i>
              <span>Description</span>
            </label>
        <div style="height: 350px; min-height:350px; max-height: 350px;" class="node-text-editor" id="node-input-description">
        </div>
    </div>

</script>

<script type="text/javascript">
(function () {

   RED.comms.subscribe("nodedev:perform-autoimport-nodes", (event,data) => {
     if ( data.msg == "autoimport" ) {
        RED.clipboard.import();
        
        setTimeout(() => {
            $('#red-ui-clipboard-dialog-import-text').val(
               data.payload
            ).trigger("paste");
        }, 300);
     }
    });

    function doSubmission(node) {

        var data = {};
        Object.keys(node._def.defaults).forEach( (nam) => {
            data[nam] = node[nam]
        })
        data["name"] = node.nodename;

        $.ajax({
            url: "NodeFactory/" + node.id,
            type: "POST",
            contentType: "application/json; charset=utf-8",

            data: JSON.stringify({
                node: data,
            }),

            success: function (resp) {
                RED.notify("Data sent", {
                    type: "warning",
                    id: "FlowHubPush",
                    timeout: 2000
                });
            },

            error: function (jqXHR, textStatus, errorThrown) {
                if (jqXHR.status == 404) {
                    RED.notify(node._("common.notification.error", {
                        message: node._("common.notification.errors.not-deployed")
                    }), "error");
                } else if (jqXHR.status == 405) {
                    RED.notify(node._("common.notification.not_allowed", {
                        message: node._("inject.errors.not_allowed")
                    }), "error");
                } else if (jqXHR.status == 500) {
                    RED.notify(node._("common.notification.error", {
                        message: node._("inject.errors.failed")
                    }), "error");
                } else if (jqXHR.status == 0) {
                    RED.notify(node._("common.notification.error", {
                        message: node._("common.notification.errors.no-response")
                    }), "error");
                } else {
                    RED.notify(node._("common.notification.error", {
                        message: node._("common.notification.errors.unexpected", {
                            status: jqXHR.status, message: textStatus
                        })
                    }), "error");
                }
            }
        });
    }
    
    RED.nodes.registerType('NodeFactory', {
        color: "#e5e4ef",
        category: 'nodedev',
        defaults: {
            name: { value: "" },
            nodename: { value: "" },
            color: { value: "#e5e4ef" },
            hasbutton: { value: false },
            hasinput: { value: true },
            outputcount: { value: 1 },
            autoimport: { value: true },
            category: { value: "" },
            summary: { value: ""},
            description: { value: ""},
            icon: { value: "font-awesome/fa-industry" }
        },
        inputs: 0,
        outputs: 1,
        icon: "font-awesome/fa-industry",
        label: function () {
            return this.name || this._def.paletteLabel;
        },
        labelStyle: function () {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function () {
            const that = this;
            const stateId = RED.editor.generateViewStateId("node", this, "");

            var sltObj = $('#node-input-outputcount');
            sltObj.html("");
            
            [0,1,2,3,4,5,6,7,8,9,10].forEach( function(v) {
                sltObj.append($('<option></option>').val(v).html(v));
            });
            
            sltObj.val(this.outputcount || "1");

            var colorPalette = [
                "#DDAA99",
                "#3FADB5", "#87A980", "#A6BBCF",
                "#AAAA66", "#C0C0C0", "#C0DEED",
                "#C7E9C0", "#D7D7A0", "#D8BFD8",
                "#DAC4B4", "#DEB887", "#DEBD5C",
                "#E2D96E", "#E6E0F8", "#E7E7AE",
                "#E9967A", "#F3B567", "#FDD0A2",
                "#FDF0C2", "#FFAAAA", "#FFCC66",
                "#FFF0F0", "#FFFFFF"
            ];

            RED.editor.colorPicker.create({
                id: "node-input-colour",
                value: this.color || "#a4a4a4",
                defaultValue: "#a4a4a4",
                palette: colorPalette,
                cellWidth: 16,
                cellHeight: 16,
                cellMargin: 3,
                none: false,
                opacity: 1.0,
                sortPalette: function (a, b) { return a.l - b.l; }
            }).appendTo("#node-input-row-style-colour");

            $("#node-input-colour").on('change', function(ev) {
                var colour = $(this).val();
                var nodeDiv = $('.red-ui-search-result-node')
                nodeDiv.css('backgroundColor',colour);
                var borderColor = RED.utils.getDarkerColor(colour);
                if (borderColor !== colour) {
                        nodeDiv.css('border-color',borderColor);
                }
            });

            this.editorSummary = RED.editor.createEditor({
               id: 'node-input-summary',
               mode: 'ace/mode/markdown',
               value: $("#node-input-summary").val()
            });

            this.editorDesc = RED.editor.createEditor({
                id: 'node-input-description',
                mode: 'ace/mode/markdown',
                value: $("#node-input-description").val()
            });

            var node = this;
            var iconRow = $('#node-input-row-icon-picker');
            $('<label data-i18n="editor.settingIcon">').appendTo(iconRow);

            var iconButton = $('<button type="button" class="red-ui-button red-ui-editor-node-appearance-button">').appendTo(iconRow);
            $('<i class="fa fa-caret-down"></i>').appendTo(iconButton);
            var nodeDiv = $('<div>',{class:"red-ui-search-result-node"}).appendTo(iconButton);
            var colour = this.color || RED.utils.getNodeColor(node.type, node._def);
            var icon_url = RED.utils.getNodeIcon(node._def,node);
            nodeDiv.css('backgroundColor',colour);
            var borderColor = RED.utils.getDarkerColor(colour);
            if (borderColor !== colour) {
                nodeDiv.css('border-color',borderColor);
            }

            var iconContainer = $('<div/>',{class:"red-ui-palette-icon-container"}).appendTo(nodeDiv);
            RED.utils.createIconElement(icon_url, iconContainer, true);

            iconButton.on("click", function(e) {
                e.preventDefault();
                var iconPath;
                var icon = $("#red-ui-editor-node-icon").val()||"";
                if (icon) {
                    iconPath = RED.utils.separateIconPath(icon);
                } else {
                    iconPath = RED.utils.getDefaultNodeIcon(node._def, node);
                }
                var backgroundColor = RED.utils.getNodeColor(node.type, node._def);
                if (node.type === "subflow") {
                    backgroundColor = $("#red-ui-editor-node-color").val();
                }
                RED.editor.iconPicker.show(iconButton,backgroundColor,iconPath,false,function(newIcon) {
                    $("#red-ui-editor-node-icon").val(newIcon||"");
                    var icon_url = RED.utils.getNodeIcon(node._def,{type:node.type,icon:newIcon});
                    RED.utils.createIconElement(icon_url, iconContainer, true);
                });
            });

            RED.popover.tooltip(iconButton, function() {
                return $("#red-ui-editor-node-icon").val() || RED._("editor.default");
            });
            $('<input type="hidden" id="red-ui-editor-node-icon">').val(node.icon).appendTo(iconRow);
        },
        
        oneditsave: function () {
            this.color = $('#node-input-colour').val();
            $("#node-input-summary").val(this.editorSummary.getValue());
            $("#node-input-description").val(this.editorDesc.getValue());
            this.icon = $('#red-ui-editor-node-icon').val();

            this.editorSummary.destroy();
            this.editorDesc.destroy();
            delete this.editorSummary;
            delete this.editorDesc;
        },

        oneditcancel: function () {
            this.editorSummary.destroy();
            this.editorDesc.destroy();
            delete this.editorSummary;
            delete this.editorDesc;
        },

        oneditresize: function (size) {
        },

        button: {
            enabled: function () {
                return !this.changed
            },

            onclick: function () {
                if (this.changed) {
                    return RED.notify(RED._("notification.warning", {
                        message: RED._("notification.warnings.undeployedChanges")
                    }), "warning");
                }

                doSubmission(this)
            }
        },
    });
})();
</script>